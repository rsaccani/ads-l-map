<!DOCTYPE html>
<html>
<head>
    <title>ADS-L Live Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        .marker-icon {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="ads-l-map" style="width: 100%; height: 800px; position: relative;">
    <div id="aircraft-counter" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 12px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; color: #333;">
        <span id="aircraft-count">0</span> ADS-L transmitters active in last 60 min
    </div>
</div>

<script>
    // Initialize map centered on Europe
    var map = L.map('ads-l-map').setView([50, 10], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var markers = {};
    var aircraftData = {}; // Store aircraft data separately

    // Function to calculate icon size based on zoom
    function getIconSize() {
        var zoom = map.getZoom();
        var baseSize = 24;
        var scaleFactor = Math.pow(1.2, zoom - 2);
        return Math.max(24, Math.min(64, baseSize * scaleFactor));
    }

    // Function to create icon with current size and heading
    function createIcon(heading) {
        var iconSize = getIconSize();
        return L.divIcon({
            html: `<div style="width: ${iconSize}px; height: ${iconSize}px; transition: all 0.3s ease;"><svg fill="#000000" width="100%" height="100%" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="-896 -896 3584.00 3584.00" style="transform: rotate(${heading}deg);"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round" stroke="#fcfcfc" stroke-width="258.048"><path d="M187.8,1659L896,132.9L1604.2,1659L896,1285.5L187.8,1659z"></path></g><g><path d="M187.8,1659L896,132.9L1604.2,1659L896,1285.5L187.8,1659z"></path></g></svg></div>`,
            className: 'marker-icon',
            iconSize: [iconSize, iconSize],
            iconAnchor: [iconSize / 2, iconSize / 2]
        });
    }

    // Function to update all marker sizes on zoom
    function updateMarkerSizes() {
        var iconSize = getIconSize();
        console.log('Updating marker sizes for zoom:', map.getZoom(), 'iconSize:', iconSize);

        for (var id in markers) {
            if (aircraftData[id]) {
                var marker = markers[id];
                var icon = marker._icon;

                if (icon) {
                    // Find the inner div that contains the SVG
                    var innerDiv = icon.querySelector('div');
                    if (innerDiv) {
                        innerDiv.style.width = iconSize + 'px';
                        innerDiv.style.height = iconSize + 'px';
                    }
                }
            }
        }
    }

    function updateMap() {
        fetch('/ads-l/')
            .then(res => res.json())
            .then(data => {
                // Update aircraft counter
                var activeCount = data.filter(d => d.lat && d.lon).length;
                document.getElementById('aircraft-count').textContent = activeCount;

                // Remove old markers
                for (var id in markers) {
                    if (!data.find(d => d.device_id === id)) {
                        map.removeLayer(markers[id]);
                        delete markers[id];
                        delete aircraftData[id];
                    }
                }

                data.forEach(d => {
                    if (d.lat && d.lon) {
                        // Store aircraft data
                        aircraftData[d.device_id] = d;

                        // Create popup content
                        var popupContent = `
              <b>Aircraft:</b> ${d.aircraft_type}<br>
              <b>Device ID:</b> ${d.device_id}<br>
              <b>Lat/Lon:</b> ${d.lat.toFixed(6)} / ${d.lon.toFixed(6)}<br>
              <b>Altitude:</b> ${d.altitude !== null ? d.altitude + ' ft (' + (d.altitude * 0.3048).toFixed(0) + ' m)' : '-'}<br>
              <b>Heading/Speed:</b> ${d.heading} / ${d.speed !== null ? d.speed + ' kts (' + (d.speed * 1.852).toFixed(2) + ' km/h)' : '-'}<br>
              <b>Vertical Speed:</b> ${d.vspeed !== null ? d.vspeed + ' fpm (' + (d.vspeed * 0.00508).toFixed(2) + ' m/s)' : '-'}<br>
              <b>GPS fix:</b> ${d.gps_fix || '-'}<br>
              <b>Routing info:</b> ${d.routing_info}<br>
              <b>Station/Signal:</b> ${d.station} / ${d.signal || '-'}<br>
              <b>Timestamp:</b> ${d.timestamp}
              <div style="max-width:300px; white-space: pre-wrap; word-break: break-word;"><b>RAW APRS data:</b> ${d.raw || '-'}</div>
            `;

                        if (markers[d.device_id]) {
                            // Update existing marker
                            markers[d.device_id]
                                .setLatLng([d.lat, d.lon])
                                .setIcon(createIcon(d.heading))
                                .setPopupContent(popupContent);
                        } else {
                            // Add new marker
                            markers[d.device_id] = L.marker([d.lat, d.lon], {icon: createIcon(d.heading)})
                                .addTo(map)
                                .bindPopup(popupContent);
                        }
                    }
                });
            })
            .catch(err => console.error("ADS-L fetch error:", err));
    }

    // Initial load
    updateMap();
    // Auto-update every 5 seconds
    setInterval(updateMap, 5000);

    // Update marker sizes on zoom - THIS MAKES IT DYNAMIC
    map.on('zoomend', function() {
        updateMarkerSizes();
    });
</script>

<h3>ADS-L monthly stats</h3>
<table id="adsl-stats" border="1" style="border-collapse: collapse; width: 300px;">
    <thead>
    <tr>
        <th>Month</th>
        <th>Devices</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
    fetch('/ads-l/stats')
        .then(resp => resp.json())
        .then(data => {
            const tbody = document.querySelector('#adsl-stats tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                const monthTd = document.createElement('td');
                monthTd.textContent = row.month;
                const devicesTd = document.createElement('td');
                devicesTd.textContent = row.devices;
                tr.appendChild(monthTd);
                tr.appendChild(devicesTd);
                tbody.appendChild(tr);
            });
        })
        .catch(err => console.error(err));
</script>

</body>
</html>