<!DOCTYPE html>
<html>
<head>
    <title>ADS-L Live Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>


<!-- part 1 -->

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div id="ads-l-map" style="width: 100%; height: 800px;"></div>

<script>
  // Initialize map
  var map = L.map('ads-l-map').setView([20, 0], 2); // global view

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var markers = {};

  function updateMap() {
    fetch('/ads-l/')  // replace with your Flask endpoint
      .then(res => res.json())
      .then(data => {
        // Remove old markers
        for (var id in markers) {
          if (!data.find(d => d.device_id === id)) {
            map.removeLayer(markers[id]);
            delete markers[id];
          }
        }

        data.forEach(d => {
          if (d.lat && d.lon) {
            // Create popup content with all available info
            var popupContent = `
              <b>Aircraft:</b> ${d.aircraft_type}<br>
              <b>Device ID:</b> ${d.device_id}<br>
              <b>Lat/Lon:</b> ${d.lat.toFixed(6)} / ${d.lon.toFixed(6)}<br>
              <b>Altitude:</b> ${d.altitude !== null ? d.altitude + ' ft (' + (d.altitude * 0.3048).toFixed(0) + ' m)' : '-'}<br>
              <b>Heading/Speed:</b> ${d.heading} / ${d.speed !== null ? d.speed + ' kts (' + (d.speed * 1.852).toFixed(2) + ' km/h)' : '-'}<br>
              <b>Vertical Speed:</b> ${d.vspeed !== null ? d.vspeed + ' fpm (' + (d.vspeed * 0.00508).toFixed(2) + ' m/s)' : '-'}<br>
              <b>GPS fix:</b> ${d.gps_fix || '-'}<br>
              <b>Routing info:</b> ${d.routing_info}<br>
              <b>Station/Signal:</b> ${d.station} / ${d.signal || '-'}<br>
              <b>Timestamp:</b> ${d.timestamp}
              <div style="max-width:300px; white-space: pre-wrap; word-break: break-word;"><b>RAW APRS data:</b> ${d.raw || '-'}</div>
            `;

            if (markers[d.device_id]) {
              // Update existing marker
              markers[d.device_id].setLatLng([d.lat, d.lon]).setPopupContent(popupContent);
            } else {
              // Add new marker
              var markerIcon = L.divIcon({
                html: `<svg fill="#000000" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(${d.heading}deg);"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="Layer_2"> <path d="M27.86,29.46L16.94,1.66c-0.1-0.27-0.31-0.49-0.58-0.59c-0.05-0.02-0.11-0.04-0.17-0.05 C16.13,1.01,16.07,1,16,1s-0.13,0.01-0.19,0.02c-0.06,0.01-0.12,0.03-0.17,0.05c-0.25,0.1-0.46,0.3-0.57,0.56l-0.01,0.03 L4.07,29.63C3.92,30,4.01,30.42,4.29,30.7C4.48,30.9,4.74,31,5,31c0.12,0,0.24-0.02,0.36-0.07L16,26.87l10.64,4.06 C26.76,30.98,26.88,31,27,31c0.01,0,0.01,0,0.02,0c0.55,0,1-0.45,1-1C28.02,29.8,27.96,29.62,27.86,29.46z" fill="#c73838"></path> <g> <path d="M28.02,30c0,0.55-0.45,1-1,1c-0.01,0-0.01,0-0.02,0c-0.12,0-0.24-0.02-0.36-0.07L16,26.87V1 c0.07,0,0.13,0.01,0.19,0.02c0.06,0.01,0.12,0.03,0.17,0.05c0.27,0.1,0.48,0.32,0.58,0.59l10.92,27.8 C27.96,29.62,28.02,29.8,28.02,30z" fill="#f47676"></path> </g> </g> <g id="Layer_3"></g> <g id="Layer_4"></g> <g id="Layer_5"></g> <g id="Layer_6"></g> <g id="Layer_7"></g> <g id="Layer_8"></g> <g id="Layer_9"></g> <g id="Layer_10"></g> <g id="Layer_11"></g> <g id="Layer_12"></g> <g id="Layer_13"></g> <g id="Layer_14"></g> <g id="Layer_15"></g> <g id="Layer_16"></g> <g id="Layer_17"></g> <g id="Layer_18"></g> <g id="Layer_19"></g> <g id="Maps_11_"></g> <g id="Maps_10_"></g> <g id="Maps_9_"></g> <g id="Maps_8_"></g> <g id="Maps_7_"></g> <g id="Maps_6_"></g> <g id="Maps_5_"></g> <g id="Maps_4_"></g> <g id="Maps_3_"></g> <g id="Maps_2_"></g> <g id="Maps_1_"></g> <g id="Maps"></g> </g></svg>`,
                className: 'marker-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
              });

              markers[d.device_id] = L.marker([d.lat, d.lon], {icon: markerIcon})
                .addTo(map)
                .bindPopup(popupContent);
            }
          }
        });
      })
      .catch(err => console.error("ADS-L fetch error:", err));
  }

  // Initial load
  updateMap();
  // Auto-update every 5 seconds
  setInterval(updateMap, 5000);
</script>


<!-- part 2 -->

<h3>ADS-L monthly stats</h3>
<table id="adsl-stats" border="1" style="border-collapse: collapse; width: 300px;">
    <thead>
        <tr>
            <th>Month</th>
            <th>Devices</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
fetch('/ads-l/stats')
  .then(resp => resp.json())
  .then(data => {
      const tbody = document.querySelector('#adsl-stats tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
          const tr = document.createElement('tr');
          const monthTd = document.createElement('td');
          monthTd.textContent = row.month;
          const devicesTd = document.createElement('td');
          devicesTd.textContent = row.devices;
          tr.appendChild(monthTd);
          tr.appendChild(devicesTd);
          tbody.appendChild(tr);
      });
  })
  .catch(err => console.error(err));
</script>



</body>
</html>

